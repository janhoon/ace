x-json-file-logging: &json_file_logging
  logging:
    driver: json-file
    options:
      labels: com.docker.compose.service,com.docker.compose.project

services:
  postgres:
    <<: *json_file_logging
    image: postgres:16-alpine
    container_name: dash-postgres
    environment:
      POSTGRES_USER: dash
      POSTGRES_PASSWORD: dash
      POSTGRES_DB: dash
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dash -d dash"]
      interval: 5s
      timeout: 5s
      retries: 5

  valkey:
    <<: *json_file_logging
    image: valkey/valkey:7
    container_name: dash-valkey
    ports:
      - "6379:6379"
    volumes:
      - valkey_data:/data
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  prometheus:
    <<: *json_file_logging
    image: prom/prometheus:v2.48.0
    container_name: dash-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'

  loki:
    <<: *json_file_logging
    image: grafana/loki:3.0.0
    container_name: dash-loki
    ports:
      - "3100:3100"
    volumes:
      - ./loki.yml:/etc/loki/local-config.yaml
      - loki_data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3100/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  victoriametrics:
    <<: *json_file_logging
    image: victoriametrics/victoria-metrics:v1.101.0
    container_name: dash-victoriametrics
    ports:
      - "8428:8428"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - victoriametrics_data:/victoria-metrics-data
    command:
      - '--promscrape.config=/etc/prometheus/prometheus.yml'
      - '--promscrape.config.strictParse=false'
      - '--storageDataPath=/victoria-metrics-data'
      - '--httpListenAddr=:8428'
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:8428/health || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5

  victorialogs:
    <<: *json_file_logging
    image: victoriametrics/victoria-logs:v1.3.1-victorialogs
    container_name: dash-victorialogs
    ports:
      - "9428:9428"
    volumes:
      - victorialogs_data:/victoria-logs-data
    command:
      - '--storageDataPath=/victoria-logs-data'
      - '--httpListenAddr=:9428'
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:9428/health || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5

  tempo:
    <<: *json_file_logging
    image: grafana/tempo:2.7.2
    container_name: dash-tempo
    command:
      - '-config.file=/etc/tempo/tempo.yml'
    ports:
      - "3200:3200"
    volumes:
      - ./tempo.yml:/etc/tempo/tempo.yml:ro
      - tempo_data:/var/tempo
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3200/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  otel-collector:
    <<: *json_file_logging
    image: otel/opentelemetry-collector-contrib:0.119.0
    container_name: dash-otel-collector
    user: "0:0"
    command:
      - '--config=/etc/otel-collector/config.yml'
    volumes:
      - ./otel-collector.yml:/etc/otel-collector/config.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - otel_collector_data:/var/lib/otelcol
    ports:
      - "4317:4317"
      - "4318:4318"
    depends_on:
      loki:
        condition: service_healthy
      victorialogs:
        condition: service_healthy
      tempo:
        condition: service_healthy

  otel-loadgen:
    <<: *json_file_logging
    image: python:3.12-alpine
    container_name: dash-otel-loadgen
    profiles:
      - otel-load
    command: ["python", "/app/otel-loadgen.py"]
    environment:
      OTEL_LOAD_TARGET: http://otel-collector:4318/v1/traces
      OTEL_LOAD_INTERVAL_SEC: 1
      OTEL_LOAD_TRACES_PER_BATCH: 8
      OTEL_LOAD_SERVICE_PREFIX: loadgen-service
      OTEL_LOAD_SERVICE_COUNT: 3
      OTEL_LOAD_ERROR_EVERY: 7
      OTEL_LOAD_ENABLE_INTERSERVICE: "true"
      OTEL_LOAD_INTERSERVICE_RATIO: "0.85"
    volumes:
      - ./otel-loadgen.py:/app/otel-loadgen.py:ro
    depends_on:
      otel-collector:
        condition: service_started
    restart: unless-stopped

volumes:
  postgres_data:
  valkey_data:
  prometheus_data:
  loki_data:
  victoriametrics_data:
  victorialogs_data:
  otel_collector_data:
  tempo_data:
