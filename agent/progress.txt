# Progress Log

## Completed Features:
1. ✅ Multi-tenancy Database Schema (PR #13)
2. ✅ Core Authentication System (PR #14)
3. ✅ Refresh Token System (PR #15)
4. ✅ Google SSO (PR #16)
5. ✅ Microsoft SSO (PR #17)
6. ✅ Multi-Auth Linking (PR #18)
7. ✅ Organization Management (PR #19 - pending)

## Feature 7: Organization Management - 2026-02-02
- What was done:
  - Created backend organization handler with full CRUD
  - Endpoints: POST/GET/PUT/DELETE /api/orgs, /api/orgs/{id}
  - Invitation system: POST /api/orgs/{id}/invitations, POST /api/invitations/{token}/accept
  - Member management: GET /api/orgs/{id}/members, PUT .../members/{userId}/role, DELETE .../members/{userId}
  - Invitations stored in Valkey with 7-day TTL
  - Role-based access control (admin, editor, viewer)
  - Protection against removing last admin
  - Created frontend organization composable for state management
  - Created OrganizationDropdown component in sidebar
  - Created CreateOrganizationModal component
  - Created OrganizationSettings page with member management
  - Added org settings route /settings/org/:id
- Files changed:
  - backend/internal/handlers/organization.go - Organization CRUD and member management
  - backend/internal/handlers/organization_test.go - Comprehensive tests
  - backend/cmd/api/main.go - Added organization routes
  - frontend/src/types/organization.ts - TypeScript types
  - frontend/src/api/organizations.ts - API functions
  - frontend/src/composables/useOrganization.ts - State management
  - frontend/src/components/OrganizationDropdown.vue - Org switcher in sidebar
  - frontend/src/components/CreateOrganizationModal.vue - Create org modal
  - frontend/src/views/OrganizationSettings.vue - Org settings page
  - frontend/src/components/Sidebar.vue - Added org dropdown
  - frontend/src/router/index.ts - Added org settings route
- PR: [will be added after creation]

## Feature 8: DataSource - Multi-Source Support - 2026-02-07
- What was done:
  - Created unified datasources table with migration (supports prometheus, loki, victorialogs, victoriametrics)
  - Updated DataSource model with type validation, IsMetrics/IsLogs helpers
  - Created backend CRUD handler for datasources (org-scoped, admin-only create/update/delete)
  - Created datasource client factory with implementations for all 4 source types
  - Prometheus client: wraps existing pkg/prometheus with unified QueryResult format
  - VictoriaMetrics client: HTTP-based PromQL-compatible API queries
  - Loki client: LogQL queries with nanosecond timestamp parsing, log level detection
  - Victoria Logs client: LogsQL queries with JSONL response parsing
  - Unified query endpoint: POST /api/datasources/{id}/query (auth required)
  - Added datasource_id column to panels table (nullable)
  - Created frontend DataSource types, API module, and composable
  - Created DataSourceSettings view with CRUD UI for managing datasources
  - Created LogViewer component (table view with timestamps, levels, labels)
  - Updated Panel.vue to support datasource-based queries and log panels
  - Updated PanelEditModal.vue with datasource dropdown and logs panel type
  - Updated Sidebar.vue with Data Sources nav item
  - Updated router with /datasources route
  - Comprehensive backend tests (handler + client factory + log level detection)
  - Comprehensive frontend tests (API module + type utilities)
- Files changed:
  - backend/internal/models/datasource.go - Unified DataSource model with type validation
  - backend/internal/db/migrations.go - Added datasources table + panels.datasource_id
  - backend/internal/handlers/datasource.go - CRUD + query handler
  - backend/internal/handlers/datasource_test.go - Handler tests
  - backend/internal/datasource/client.go - Client interface + factory
  - backend/internal/datasource/prometheus.go - Prometheus client
  - backend/internal/datasource/victoriametrics.go - VictoriaMetrics client
  - backend/internal/datasource/loki.go - Loki client
  - backend/internal/datasource/victorialogs.go - Victoria Logs client
  - backend/internal/datasource/client_test.go - Client factory + log detection tests
  - backend/cmd/api/main.go - Registered datasource routes
  - frontend/src/types/datasource.ts - TypeScript types + utilities
  - frontend/src/types/datasource.spec.ts - Type utility tests
  - frontend/src/api/datasources.ts - API functions
  - frontend/src/api/datasources.spec.ts - API tests
  - frontend/src/composables/useDatasource.ts - State management
  - frontend/src/views/DataSourceSettings.vue - CRUD UI
  - frontend/src/components/LogViewer.vue - Log table component
  - frontend/src/components/Panel.vue - Datasource + log support
  - frontend/src/components/PanelEditModal.vue - Datasource dropdown + logs type
  - frontend/src/components/Sidebar.vue - Data Sources nav item
  - frontend/src/router/index.ts - /datasources route
- Tests: passing (backend all pass, frontend new tests pass, pre-existing failures unchanged)

## ALL FEATURES COMPLETE

## Task FOLDER-DB-001: Create folder storage schema - 2026-02-08T15:42:34Z
- What was done:
  - Added folder persistence migration with organization scoping, optional parent hierarchy, sort ordering, and audit fields
  - Added nullable dashboard folder placement columns (`folder_id`, `sort_order`) with foreign key support
  - Added folder/dashboard indexes for org/folder lookup and sort ordering
  - Updated migration tests to account for `folders` and `datasources` tables in setup and verification
- Files changed:
  - backend/internal/db/migrations.go
  - backend/internal/db/migrations_test.go
  - agent/prd.json
  - agent/progress.txt
- Tests: passing (`cd backend && go test ./...`)
- Browser validation: n/a (no frontend changes)

## Task FOLDER-BE-001: Add folder backend CRUD endpoints - 2026-02-08T15:46:24Z
- What was done:
  - Added first-class folder backend model and CRUD HTTP handler with organization scoping
  - Implemented membership-based read access and viewer write restrictions for create/update/delete
  - Added parent-folder validation to ensure parent folders exist in the same organization
  - Registered folder routes for org-scoped list/create and ID-scoped get/update/delete
- Files changed:
  - backend/internal/models/folder.go
  - backend/internal/handlers/folders.go
  - backend/cmd/api/main.go
  - agent/prd.json
  - agent/progress.txt
- Tests: passing (`cd backend && go test ./...`)
- Browser validation: n/a (no frontend changes)

## Task FOLDER-FE-API-001: Add frontend folder types and API client - 2026-02-08T17:01:35Z
- What was done:
  - Added typed folder domain models and create/update request payload interfaces in the frontend types layer
  - Added folder API client functions for list/get/create/update/delete with auth headers and normalized API error handling
  - Added Vitest coverage for folder API request paths, HTTP methods, payloads, auth headers, and key error responses
- Files changed:
  - frontend/src/types/folder.ts
  - frontend/src/api/folders.ts
  - frontend/src/api/folders.spec.ts
  - agent/prd.json
  - agent/progress.txt
- Tests: failing (`cd frontend && npm run type-check && npm run test` has pre-existing failures outside folder API); passing (`cd frontend && npm run test -- src/api/folders.spec.ts`)
- Browser validation: passing (login/register mode toggle happy path, failed sign-in state renders error message without UI/runtime crash)

## Task FOLDER-FE-API-001: Add frontend folder types and API client - 2026-02-08T17:16:56Z
- What was done:
  - Verified the existing folder type definitions and folder API client implementation satisfy task requirements
  - Confirmed folder API tests cover request URLs, methods, payload handling, auth headers, and error normalization
  - Marked this task as passing in `agent/prd.json`
- Files changed:
  - agent/prd.json
  - agent/progress.txt
- Tests: failing (`cd frontend && npm run type-check && npm run test` has pre-existing failures in unrelated suites: `src/api/dashboards.spec.ts`, `src/components/CreateDashboardModal.spec.ts`, `src/components/DashboardList.spec.ts`, `src/components/Panel.spec.ts`); passing (`cd frontend && npm run test -- src/api/folders.spec.ts`)
- Browser validation: n/a (no frontend source changes in this session)

## Task FOLDER-FE-UI-001: Render dashboards grouped by folders - 2026-02-08T17:22:50Z
- What was done:
  - Updated dashboard listing data load to fetch folders and dashboards together per selected organization
  - Added grouped dashboard rendering with per-folder sections plus an explicit `Unfiled Dashboards` section for dashboards without a valid folder assignment
  - Kept existing dashboard interactions (open, edit, delete, create) within grouped sections and added grouping-focused unit coverage
  - Marked this task as passing in `agent/prd.json`
- Files changed:
  - frontend/src/components/DashboardList.vue
  - frontend/src/components/DashboardList.spec.ts
  - frontend/src/types/dashboard.ts
  - agent/prd.json
  - agent/progress.txt
- Tests: failing (`cd frontend && npm run type-check && npm run test` has pre-existing failures outside touched files in `src/api/dashboards.spec.ts`, `src/components/CreateDashboardModal.spec.ts`, `src/components/Panel.spec.ts`); passing (`cd frontend && npm run test -- src/components/DashboardList.spec.ts`)
- Browser validation: passing (happy path verified folder + unfiled grouping on `/dashboards`; permission/failure state verified 403 renders `Not a member of this organization`; no runtime JS errors observed)

## Task RBAC-DB-001: Create user groups and resource permission schema - 2026-02-08T17:24:54Z
- What was done:
  - Added migration schema for `user_groups`, `user_group_memberships`, and `resource_permissions` with org scoping and RBAC-oriented check constraints
  - Added indexes for group lookup, membership lookup, and ACL resource/principal lookup paths
  - Extended migration tests to validate new table creation/removal and constraint behavior for user/group principals and permission levels
  - Marked this task as passing in `agent/prd.json`
- Files changed:
  - backend/internal/db/migrations.go
  - backend/internal/db/migrations_test.go
  - agent/prd.json
  - agent/progress.txt
- Tests: passing (`cd backend && go test ./...`)
- Browser validation: n/a (no frontend changes)

## Task RBAC-BE-GROUPS-001: Add backend user group CRUD endpoints - 2026-02-08T17:29:21Z
- What was done:
  - Added an organization-scoped `GroupHandler` with create/list/update/delete endpoints for user groups
  - Enforced access rules so org members can list groups and only org admins can create/update/delete
  - Added duplicate-name conflict handling and org-scoped update/delete behavior with consistent JSON error payloads
  - Added integration tests covering CRUD behavior, admin-only write enforcement, and organization scoping
  - Registered group routes in the API router and marked this task as passing in `agent/prd.json`
- Files changed:
  - backend/internal/models/group.go
  - backend/internal/handlers/groups.go
  - backend/internal/handlers/groups_test.go
  - backend/cmd/api/main.go
  - agent/prd.json
  - agent/progress.txt
- Tests: passing (`cd backend && go test ./...`)
- Browser validation: n/a (no frontend changes)

## Task RBAC-BE-GROUPS-002: Add group membership endpoints - 2026-02-08T17:34:37Z
- What was done:
  - Added group membership endpoints to list members, add members, and remove members for organization groups
  - Enforced admin-only mutation permissions for add/remove while keeping list access to organization members
  - Added validation to reject cross-organization user assignment and return conflict on duplicate memberships
  - Added handler tests covering membership lifecycle, admin-only enforcement, cross-org rejection, and duplicate prevention
- Files changed:
  - backend/internal/models/group.go
  - backend/internal/handlers/groups.go
  - backend/internal/handlers/groups_test.go
  - backend/cmd/api/main.go
  - agent/prd.json
  - agent/progress.txt
- Tests: passing (`cd backend && go test ./...`)
- Browser validation: n/a (no frontend changes)

## Task RBAC-BE-PERM-001: Implement effective permission evaluation service - 2026-02-08T17:39:37Z
- What was done:
  - Added a new backend `authz` service package to resolve folder/dashboard permissions from organization role, direct user grants, and group grants
  - Implemented deterministic precedence rules: org admin full access, explicit ACL evaluation when ACL entries exist, org-role fallback when no ACL exists, and fail-closed behavior for unknown resources or non-members
  - Added action-level checks (`view`, `edit`, `admin`) via `Can(...)` and permission rank comparison
  - Added authz service tests covering direct grants, group grants, org-role fallback, admin full access, and fail-closed paths
- Files changed:
  - backend/internal/authz/service.go
  - backend/internal/authz/service_test.go
  - agent/prd.json
  - agent/progress.txt
- Tests: passing (`cd backend && go test ./...`)
- Browser validation: n/a (no frontend changes)

## Task RBAC-BE-PERM-002: Enforce permissions in folder and dashboard handlers - 2026-02-08T17:44:13Z
- What was done:
  - Integrated RBAC authorization checks into folder and dashboard handlers so list/get operations require `view` and update/delete operations require `edit`
  - Applied permission-aware filtering to folder and dashboard list endpoints so responses only include resources the caller can view
  - Updated panel handlers to require authenticated users and enforce dashboard-level `view`/`edit` permission checks for panel list/create/update/delete operations
  - Wrapped panel routes with JWT auth middleware in the API router so panel endpoints consistently run with authenticated user context
- Files changed:
  - backend/internal/handlers/folders.go
  - backend/internal/handlers/dashboards.go
  - backend/internal/handlers/panels.go
  - backend/cmd/api/main.go
  - agent/prd.json
  - agent/progress.txt
- Tests: passing (`cd backend && go test ./...`)
- Browser validation: n/a (no frontend changes)

## Task RBAC-BE-PERM-003: Add folder/dashboard permission management endpoints - 2026-02-08T20:18:38Z
- What was done:
  - Added a backend `PermissionHandler` with admin-only endpoints to list and replace ACL entries for folders and dashboards
  - Implemented atomic ACL replacement using a transaction that clears and recreates entries per resource
  - Added validation to reject principals outside the resource organization for both `user` and `group` principal types
  - Added integration tests covering folder/dashboard ACL lifecycle, non-admin access denial, cross-org validation, and effective permission changes through authz resolution
- Files changed:
  - backend/internal/models/permission.go
  - backend/internal/handlers/permissions.go
  - backend/internal/handlers/permissions_test.go
  - backend/cmd/api/main.go
  - agent/prd.json
  - agent/progress.txt
- Tests: passing (`cd backend && go test ./...`)
- Browser validation: n/a (no frontend changes)

## Task RBAC-FE-API-001: Add frontend groups and ACL API modules - 2026-02-08T20:24:04Z
- What was done:
  - Added typed RBAC frontend models for user groups, group memberships, ACL entries, and replace-permissions payloads
  - Added `groups` API module for org-scoped group CRUD and membership management endpoints with auth headers and normalized backend error handling
  - Added `permissions` API module for folder/dashboard ACL list and replace endpoints with status-aware error messages
  - Added focused Vitest coverage for group and permission API modules covering endpoint paths, methods, request payloads, auth headers, and error payload handling
- Files changed:
  - frontend/src/types/rbac.ts
  - frontend/src/api/groups.ts
  - frontend/src/api/groups.spec.ts
  - frontend/src/api/permissions.ts
  - frontend/src/api/permissions.spec.ts
  - agent/prd.json
  - agent/progress.txt
- Tests: failing (`cd frontend && npm run type-check && npm run test` has pre-existing failures outside touched files: `src/api/dashboards.spec.ts`, `src/components/CreateDashboardModal.spec.ts`, `src/components/Panel.spec.ts`); passing (`cd frontend && npm run test -- src/api/groups.spec.ts src/api/permissions.spec.ts`)
- Browser validation: passing (happy path: `/login` mode toggle login -> register -> login; failure state: invalid sign-in shows `Invalid email or password`; no runtime page errors while exercising flow)

## Task RBAC-FE-UI-ORG-001: Add user groups management section in organization settings - 2026-02-08T20:44:28Z
- What was done:
  - Added a full Groups section to organization settings with list/create/rename/delete flows wired to the groups API module
  - Added per-group membership management with expandable member panels, add/remove controls for admins, and read-only visibility for non-admin roles
  - Added clear groups and group-members states (loading, empty, and error) plus inline success/error feedback for group actions
  - Added view tests covering admin group management flows, non-admin destructive-control restrictions, and empty/error rendering states
- Files changed:
  - frontend/src/views/OrganizationSettings.vue
  - frontend/src/views/OrganizationSettings.spec.ts
  - agent/prd.json
  - agent/progress.txt
- Tests: failing (`cd frontend && npm run type-check && npm run test` has pre-existing failures outside touched files: `src/api/dashboards.spec.ts`, `src/components/CreateDashboardModal.spec.ts`, `src/components/Panel.spec.ts`); passing (`cd frontend && npm run test -- src/views/OrganizationSettings.spec.ts`)
- Browser validation: passing (happy path: admin opened `/settings/org/org-1`, created a group, expanded group members, added a member; permission state: viewer role had no `New Group` or add-member controls; no runtime page errors observed)

## Task FOLDER-FE-UI-003: Allow moving dashboards between folders - 2026-02-08T20:51:38Z
- What was done:
  - Added folder selection to dashboard edit flow so users can move dashboards to a folder or back to `Unfiled (Root)`
  - Wired frontend dashboard update payloads to include `folder_id` and refreshed grouped dashboard sections after save
  - Extended backend dashboard model/handlers to read/write `folder_id` in list/get/update responses and enforce org-scoped folder validation on moves
  - Added request parsing support for explicit `folder_id: null` updates so moving dashboards back to root persists correctly
- Files changed:
  - frontend/src/components/EditDashboardModal.vue
  - frontend/src/components/EditDashboardModal.spec.ts
  - frontend/src/components/DashboardList.vue
  - frontend/src/types/dashboard.ts
  - backend/internal/models/dashboard.go
  - backend/internal/handlers/dashboards.go
  - backend/internal/handlers/dashboards_test.go
  - agent/prd.json
  - agent/progress.txt
- Tests: failing (`cd frontend && npm run type-check && npm run test` has pre-existing failures outside touched files: `src/api/dashboards.spec.ts`, `src/components/CreateDashboardModal.spec.ts`, `src/components/Panel.spec.ts`); passing (`cd frontend && npm run test -- src/components/EditDashboardModal.spec.ts src/components/DashboardList.spec.ts`, `cd backend && go test ./...`)
- Browser validation: passing (happy path: on `/dashboards`, moved `Folder Move Demo` from unfiled to `Operations` using the new folder picker, then moved it back to `Unfiled (Root)`; failure state: with an invalid `current_org_id`, dashboards view showed `Not a member of this organization`; no runtime page errors observed)

## Task RBAC-BE-TEST-001: Add RBAC permission matrix tests - 2026-02-08T20:55:28Z
- What was done:
  - Extended authz service coverage with a group-permission revoke scenario that verifies access is removed after group membership deletion
  - Added handler integration coverage that ensures folder and dashboard get/update endpoints return 403 when a member is excluded by ACL entries
  - Kept fixtures organization-isolated by creating dedicated users, memberships, and ACL resources per test case
- Files changed:
  - backend/internal/authz/service_test.go
  - backend/internal/handlers/permissions_test.go
  - agent/prd.json
  - agent/progress.txt
- Tests: passing (`cd backend && go test ./...`)
- Browser validation: n/a (no frontend changes)

## Task RBAC-FE-UI-FOLDER-001: Add folder permission editor UI - 2026-02-08T21:30:09Z
- What was done:
  - Added a new folder permissions modal UI with ACL entry loading, user/group principal pickers, add/remove/edit interactions, duplicate-entry validation, and save-to-API flow
  - Wired folder-level `Permissions` controls into dashboard folder sections for org admins only, including post-save success feedback in the dashboards view
  - Added frontend tests for folder permissions modal happy path + validation errors and dashboard-list role-based visibility of the folder permissions action
  - Marked this task as passing in `agent/prd.json`
- Files changed:
  - frontend/src/components/FolderPermissionsModal.vue
  - frontend/src/components/FolderPermissionsModal.spec.ts
  - frontend/src/components/DashboardList.vue
  - frontend/src/components/DashboardList.spec.ts
  - agent/prd.json
  - agent/progress.txt
- Tests: failing (`cd frontend && npm run type-check && npm run test` has pre-existing failures outside touched files: `src/api/dashboards.spec.ts`, `src/components/CreateDashboardModal.spec.ts`, `src/components/Panel.spec.ts`); passing (`cd frontend && npm run test -- src/components/DashboardList.spec.ts src/components/FolderPermissionsModal.spec.ts`)
- Browser validation: passing (happy path: logged in as admin, opened `/dashboards` folder `Permissions`, added a user ACL entry, saved successfully; permission/failure state: forced invalid `current_org_id` and confirmed `Not a member of this organization`; no runtime page errors observed)

## Task RBAC-FE-UI-DASH-001: Add dashboard permission editor UI - 2026-02-08T21:43:19Z
- What was done:
  - Added `DashboardPermissionsModal` with ACL load/edit/save support for user/group principals, duplicate-entry validation, and inline success/error feedback
  - Wired a `Permissions` action into `DashboardDetailView` so dashboard ACLs can be edited from the dashboard detail flow
  - Added dashboard-detail feedback after ACL updates and ensured org context is loaded before resolving permission controls
  - Added frontend tests for dashboard ACL modal behavior and dashboard-detail permission action visibility/open flow
- Files changed:
  - frontend/src/components/DashboardPermissionsModal.vue
  - frontend/src/components/DashboardPermissionsModal.spec.ts
  - frontend/src/views/DashboardDetailView.vue
  - frontend/src/views/DashboardDetailView.spec.ts
  - agent/prd.json
  - agent/progress.txt
- Tests: failing (`cd frontend && npm run type-check && npm run test` has pre-existing failures outside touched files: `src/api/dashboards.spec.ts`, `src/components/CreateDashboardModal.spec.ts`, `src/components/Panel.spec.ts`); passing (`cd frontend && npm run test -- src/components/DashboardPermissionsModal.spec.ts src/views/DashboardDetailView.spec.ts`)
- Browser validation: passing (happy path: opened `/dashboards/85b40e99-6ae4-4b21-8cf1-afa2ee805c5c`, opened dashboard `Permissions`, validated duplicate-principal error state, and saved ACL successfully; failure state: opened `/dashboards/not-a-real-dashboard-id` and confirmed `Dashboard not found`; no runtime page errors observed)

## Task SSO-FE-API-001: Add frontend organization SSO API module - 2026-02-08T21:48:10Z
- What was done:
  - Added new frontend SSO type models for Google and Microsoft org config responses and update payloads
  - Added SSO API client functions to get/update Google and Microsoft org SSO configs using org-scoped endpoints
  - Added status-aware + payload-aware error normalization for common SSO responses (403 admin required, 404 not configured, backend-provided validation messages)
  - Added Vitest coverage for endpoint paths, methods, request payloads, auth header behavior, and error handling
- Files changed:
  - frontend/src/types/sso.ts
  - frontend/src/api/sso.ts
  - frontend/src/api/sso.spec.ts
  - agent/prd.json
  - agent/progress.txt
- Tests: failing (`cd frontend && npm run type-check && npm run test` has pre-existing failures outside touched files: `src/api/dashboards.spec.ts`, `src/components/CreateDashboardModal.spec.ts`, `src/components/Panel.spec.ts`); passing (`cd frontend && npm run test -- src/api/sso.spec.ts`)
- Browser validation: passing (happy path: opened `/login`, toggled login -> register -> login mode successfully; failure state: attempted invalid sign-in and confirmed `Invalid email or password`; no runtime page errors observed while exercising the flow)

## Task SSO-FE-UI-001: Add SSO configuration section in organization settings - 2026-02-08T21:57:49Z
- What was done:
  - Added a new `Single Sign-On` section to `OrganizationSettings` with separate Google and Microsoft config cards
  - Loaded existing org SSO provider configs on page load, with graceful handling when a provider is not configured yet
  - Added admin-only save actions for Google/Microsoft configs (client IDs/secrets, tenant ID, enabled toggles), with inline success/error feedback
  - Kept SSO controls visible but read-only for non-admin users
  - Extended `OrganizationSettings` tests to cover SSO load/save, non-admin restrictions, and provider load-error rendering
- Files changed:
  - frontend/src/views/OrganizationSettings.vue
  - frontend/src/views/OrganizationSettings.spec.ts
  - agent/prd.json
  - agent/progress.txt
- Tests: failing (`cd frontend && npm run type-check && npm run test` has pre-existing failures outside touched files: `src/api/dashboards.spec.ts`, `src/components/CreateDashboardModal.spec.ts`, `src/components/Panel.spec.ts`); passing (`cd frontend && npm run test -- src/views/OrganizationSettings.spec.ts`)
- Browser validation: passing (happy path: opened `/settings/org/<current_org_id>`, verified SSO section renders for Google/Microsoft and successfully saved Google SSO settings; failure state: opened `/settings/org/not-a-real-org-id` and confirmed `Organization not found`; no runtime browser errors while exercising the flow)
