[
  {
    "category": "Database - Multi-tenancy Schema",
    "description": "Multi-tenancy Database Schema - Foundation for organizations, users, roles, and memberships.",
    "requirements": {
      "organizations": "Isolated tenants with name and slug",
      "users": "Can belong to multiple orgs, email-based auth",
      "memberships": "User-org relationships with roles (admin, editor, viewer)",
      "sso_configs": "Per-org Google/Microsoft SSO configuration",
      "datasources": "Per-org Prometheus data sources",
      "migrations": "Reversible migrations with indexes"
    },
    "steps": [
      "Create migration file: backend/internal/db/migrations/006_multi_tenancy.sql",
      "Create organizations table (id, name, slug, timestamps)",
      "Create users table (id, email, password_hash, name, timestamps)",
      "Create organization_memberships table (org_id, user_id, role, timestamps)",
      "Create user_auth_methods table (user_id, provider, provider_user_id)",
      "Create sso_configs table (org_id, provider, client_id, client_secret, tenant_id)",
      "Create prometheus_datasources table (org_id, name, url, is_default)",
      "ALTER dashboards ADD COLUMN organization_id, created_by",
      "ALTER panels ADD COLUMN created_by",
      "Add indexes on organization_id, user_id, email, slug",
      "Add foreign key constraints with CASCADE deletes",
      "Create default 'Personal' organization for existing data",
      "TEST: Run migration on fresh DB",
      "TEST: Run migration on existing DB",
      "TEST: Verify cascade deletes work",
      "TEST: Down migration removes all changes"
    ],
    "passes": true
  }
]
