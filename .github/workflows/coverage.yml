name: Coverage

on:
  push:
    branches:
      - master
    paths-ignore:
      - '.github/badges/coverage-summary.json'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' }}

permissions:
  contents: read

jobs:
  coverage:
    name: Coverage (Frontend + Backend)
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: backend/go.mod

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Run backend coverage
        id: backend
        run: |
          go test ./... -coverprofile=coverage.out
          go tool cover -func=coverage.out | tee coverage-func.txt
          backend_statements="$(awk '/^total:/ { gsub("%", "", $3); print $3 }' coverage-func.txt)"
          printf "backend_statements=%s\n" "$backend_statements" >> "$GITHUB_OUTPUT"
        working-directory: backend

      - name: Run frontend coverage
        id: frontend
        run: |
          npm run test:coverage -- --coverage.reporter=text-summary --coverage.reporter=json-summary
          frontend_statements="$(node -e "const fs=require('fs');const d=JSON.parse(fs.readFileSync('coverage/coverage-summary.json','utf8'));process.stdout.write(String(d.total.statements.pct));")"
          printf "frontend_statements=%s\n" "$frontend_statements" >> "$GITHUB_OUTPUT"
        working-directory: frontend

      - name: Generate coverage badge payload
        env:
          FRONTEND_STATEMENTS: ${{ steps.frontend.outputs.frontend_statements }}
          BACKEND_STATEMENTS: ${{ steps.backend.outputs.backend_statements }}
        run: |
          python3 - <<'PY'
          import json
          import os

          fe = float(os.environ['FRONTEND_STATEMENTS'])
          be = float(os.environ['BACKEND_STATEMENTS'])
          avg = (fe + be) / 2

          if avg >= 80:
              color = 'brightgreen'
          elif avg >= 65:
              color = 'green'
          elif avg >= 50:
              color = 'yellowgreen'
          elif avg >= 35:
              color = 'yellow'
          elif avg >= 20:
              color = 'orange'
          else:
              color = 'red'

          payload = {
              'schemaVersion': 1,
              'label': 'coverage',
              'message': f'fe {fe:.2f}% | be {be:.1f}%',
              'color': color,
          }

          os.makedirs('.github/badges', exist_ok=True)
          with open('.github/badges/coverage-summary.json', 'w', encoding='utf-8') as fh:
              json.dump(payload, fh, separators=(',', ':'))
          PY

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            backend/coverage.out
            backend/coverage-func.txt
            frontend/coverage/coverage-summary.json

      - name: Commit updated coverage badge
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ci: update coverage badge [skip ci]'
          file_pattern: .github/badges/coverage-summary.json
