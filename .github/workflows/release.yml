name: Release

on:
  release:
    types:
      - published

concurrency:
  group: release-${{ github.event.release.tag_name }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  id-token: write
  attestations: write

env:
  RELEASE_TAG: ${{ github.event.release.tag_name }}

jobs:
  backend-verify:
    name: Verify Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: backend/go.mod

      - name: Run backend tests
        run: go test ./...
        working-directory: backend

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          working-directory: backend
          args: --timeout=5m ./...

      - name: Run govulncheck
        run: go run golang.org/x/vuln/cmd/govulncheck@latest ./...
        working-directory: backend

  frontend-verify:
    name: Verify Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Run frontend lint
        run: npm run lint
        working-directory: frontend

      - name: Run frontend dead-code lint
        run: npm run lint:dead-code
        working-directory: frontend

      - name: Run frontend tests
        run: npm run test
        working-directory: frontend

      - name: Build frontend
        run: npx vite build
        working-directory: frontend

  secret-scan:
    name: Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ env.RELEASE_TAG }}
          fetch-depth: 0

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-backend-binaries:
    name: Build Backend Binary (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ubuntu-latest
    needs:
      - backend-verify
      - frontend-verify
      - secret-scan
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
            ext: ''
            archive: tar.gz
          - goos: linux
            goarch: arm64
            ext: ''
            archive: tar.gz
          - goos: darwin
            goarch: amd64
            ext: ''
            archive: tar.gz
          - goos: darwin
            goarch: arm64
            ext: ''
            archive: tar.gz
          - goos: windows
            goarch: amd64
            ext: .exe
            archive: zip
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: backend/go.mod

      - name: Build and package binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          EXT: ${{ matrix.ext }}
          ARCHIVE: ${{ matrix.archive }}
        run: |
          set -euo pipefail
          version="${RELEASE_TAG#v}"
          base="dash-backend_${version}_${GOOS}_${GOARCH}"
          staging="dist/${base}"

          mkdir -p "$staging"
          CGO_ENABLED=0 GOOS="$GOOS" GOARCH="$GOARCH" go build -trimpath -o "$staging/dash-api${EXT}" ./cmd/api

          if [ "$ARCHIVE" = "zip" ]; then
            (cd dist && zip -r "${base}.zip" "${base}")
          else
            (cd dist && tar -czf "${base}.tar.gz" "${base}")
          fi
        working-directory: backend

      - name: Upload backend package
        uses: actions/upload-artifact@v4
        with:
          name: backend-package-${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            backend/dist/*.tar.gz
            backend/dist/*.zip

  build-frontend-artifact:
    name: Build Frontend Artifact
    runs-on: ubuntu-latest
    needs:
      - backend-verify
      - frontend-verify
      - secret-scan
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Build frontend
        run: npx vite build
        working-directory: frontend

      - name: Create frontend release tarball
        run: |
          set -euo pipefail
          version="${RELEASE_TAG#v}"
          mkdir -p dist-release
          tar -czf "dist-release/dash-frontend_${version}.tar.gz" -C frontend dist

      - name: Upload frontend package
        uses: actions/upload-artifact@v4
        with:
          name: frontend-package
          path: dist-release/*.tar.gz

  docker-backend:
    name: Publish Backend Image
    runs-on: ubuntu-latest
    needs:
      - backend-verify
      - frontend-verify
      - secret-scan
    env:
      PRERELEASE: ${{ github.event.release.prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute backend image tags
        id: vars
        run: |
          set -euo pipefail
          version="${RELEASE_TAG#v}"
          major="${version%%.*}"
          remainder="${version#*.}"
          minor="${remainder%%.*}"
          repo="ghcr.io/${GITHUB_REPOSITORY_OWNER,,}/dash-backend"

          {
            printf "image_repo=%s\n" "$repo"
            printf "tags<<EOF\n"
            printf "%s:%s\n" "$repo" "$RELEASE_TAG"
            printf "%s:%s\n" "$repo" "$version"
            printf "%s:%s.%s\n" "$repo" "$major" "$minor"
            printf "%s:%s\n" "$repo" "$major"
            printf "%s:sha-%s\n" "$repo" "${GITHUB_SHA::7}"
            if [ "$PRERELEASE" != "true" ]; then
              printf "%s:latest\n" "$repo"
            fi
            printf "EOF\n"
          } >> "$GITHUB_OUTPUT"

      - name: Build and push backend image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: backend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.vars.outputs.tags }}
          labels: |
            org.opencontainers.image.title=Dash Backend
            org.opencontainers.image.description=Dash backend API service
            org.opencontainers.image.version=${{ env.RELEASE_TAG }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign backend image (keyless)
        env:
          COSIGN_YES: true
        run: cosign sign "${{ steps.vars.outputs.image_repo }}@${{ steps.build.outputs.digest }}"

      - name: Attest backend image provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ${{ steps.vars.outputs.image_repo }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

      - name: Install syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Generate backend image SBOM
        run: |
          syft "${{ steps.vars.outputs.image_repo }}@${{ steps.build.outputs.digest }}" \
            -o spdx-json=sbom-backend-image-${RELEASE_TAG#v}.spdx.json

      - name: Upload backend image SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-backend-image
          path: sbom-backend-image-*.spdx.json

  docker-frontend:
    name: Publish Frontend Image
    runs-on: ubuntu-latest
    needs:
      - backend-verify
      - frontend-verify
      - secret-scan
    env:
      PRERELEASE: ${{ github.event.release.prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute frontend image tags
        id: vars
        run: |
          set -euo pipefail
          version="${RELEASE_TAG#v}"
          major="${version%%.*}"
          remainder="${version#*.}"
          minor="${remainder%%.*}"
          repo="ghcr.io/${GITHUB_REPOSITORY_OWNER,,}/dash-frontend"

          {
            printf "image_repo=%s\n" "$repo"
            printf "tags<<EOF\n"
            printf "%s:%s\n" "$repo" "$RELEASE_TAG"
            printf "%s:%s\n" "$repo" "$version"
            printf "%s:%s.%s\n" "$repo" "$major" "$minor"
            printf "%s:%s\n" "$repo" "$major"
            printf "%s:sha-%s\n" "$repo" "${GITHUB_SHA::7}"
            if [ "$PRERELEASE" != "true" ]; then
              printf "%s:latest\n" "$repo"
            fi
            printf "EOF\n"
          } >> "$GITHUB_OUTPUT"

      - name: Build and push frontend image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: frontend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.vars.outputs.tags }}
          labels: |
            org.opencontainers.image.title=Dash Frontend
            org.opencontainers.image.description=Dash frontend SPA
            org.opencontainers.image.version=${{ env.RELEASE_TAG }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign frontend image (keyless)
        env:
          COSIGN_YES: true
        run: cosign sign "${{ steps.vars.outputs.image_repo }}@${{ steps.build.outputs.digest }}"

      - name: Attest frontend image provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ${{ steps.vars.outputs.image_repo }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

      - name: Install syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Generate frontend image SBOM
        run: |
          syft "${{ steps.vars.outputs.image_repo }}@${{ steps.build.outputs.digest }}" \
            -o spdx-json=sbom-frontend-image-${RELEASE_TAG#v}.spdx.json

      - name: Upload frontend image SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-frontend-image
          path: sbom-frontend-image-*.spdx.json

  checksums:
    name: Create Artifact Checksums
    runs-on: ubuntu-latest
    needs:
      - build-backend-binaries
      - build-frontend-artifact
    steps:
      - name: Download backend packages
        uses: actions/download-artifact@v5
        with:
          pattern: backend-package-*
          merge-multiple: true
          path: release-assets/backend

      - name: Download frontend package
        uses: actions/download-artifact@v5
        with:
          name: frontend-package
          path: release-assets/frontend

      - name: Generate SHA256 checksums
        run: |
          set -euo pipefail
          sha256sum release-assets/backend/* release-assets/frontend/* > release-assets/checksums.txt

      - name: Upload checksums file
        uses: actions/upload-artifact@v4
        with:
          name: release-checksums
          path: release-assets/checksums.txt

  publish-release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs:
      - build-backend-binaries
      - build-frontend-artifact
      - docker-backend
      - docker-frontend
      - checksums
    steps:
      - name: Download backend packages
        uses: actions/download-artifact@v5
        with:
          pattern: backend-package-*
          merge-multiple: true
          path: release-assets/backend

      - name: Download frontend package
        uses: actions/download-artifact@v5
        with:
          name: frontend-package
          path: release-assets/frontend

      - name: Download checksums
        uses: actions/download-artifact@v5
        with:
          name: release-checksums
          path: release-assets

      - name: Download backend image SBOM
        uses: actions/download-artifact@v5
        with:
          name: sbom-backend-image
          path: release-assets/sbom

      - name: Download frontend image SBOM
        uses: actions/download-artifact@v5
        with:
          name: sbom-frontend-image
          path: release-assets/sbom

      - name: Upload assets to GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: |
            release-assets/backend/*.tar.gz
            release-assets/backend/*.zip
            release-assets/frontend/*.tar.gz
            release-assets/checksums.txt
            release-assets/sbom/*.spdx.json
          fail_on_unmatched_files: true
