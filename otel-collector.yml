extensions:
  file_storage:
    directory: /var/lib/otelcol/file_storage
    create_directory: true

receivers:
  filelog/docker:
    include:
      - /var/lib/docker/containers/*/*-json.log
    include_file_path: true
    start_at: end
    storage: file_storage
    operators:
      - type: json_parser
        parse_from: body
        timestamp:
          parse_from: attributes.time
          layout: '%Y-%m-%dT%H:%M:%S.%fZ'
      - type: move
        from: attributes.log
        to: body
      - type: regex_parser
        parse_from: attributes["log.file.path"]
        regex: '^/var/lib/docker/containers/(?P<container_id>[a-f0-9]{64})/.+$'
      - type: add
        field: attributes.source
        value: docker

processors:
  batch: {}

exporters:
  otlphttp/loki:
    endpoint: http://loki:3100/otlp
    tls:
      insecure: true
  otlphttp/victorialogs:
    endpoint: http://victorialogs:9428/insert/opentelemetry
    tls:
      insecure: true

service:
  extensions:
    - file_storage
  pipelines:
    logs:
      receivers:
        - filelog/docker
      processors:
        - batch
      exporters:
        - otlphttp/loki
        - otlphttp/victorialogs
